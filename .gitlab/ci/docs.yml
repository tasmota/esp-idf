.patterns-docs-full: &patterns-docs-full
  - ".gitlab/ci/docs.yml"
  - "docs/**/*"
  - "**/*.rst"
  - "CONTRIBUTING.rst"
  - "**/soc_caps.h"
  - "**/Kconfig*"

.patterns-docs-partial: &patterns-docs-partial
  - "components/**/*.h"
  - "components/**/CMakeLists.txt"
  - "components/**/sdkconfig*"
  - "tools/tools.json"
  - "tools/idf_tools.py"

.patterns-example-readme: &patterns-example-readme
  - "examples/**/*.md"

.patterns-docs-preview: &patterns-docs-preview
  - "docs/**/*"

.if-protected-check: &if-protected-check
  if: '($CI_COMMIT_REF_NAME == "master" || $CI_COMMIT_BRANCH =~ /^release\/v/ || $CI_COMMIT_TAG =~ /^v\d+\.\d+(\.\d+)?($|-)/)'

.if-qa-test-tag: &if-qa-test-tag
  if: '$CI_COMMIT_TAG =~ /^qa-test/'

.if-label-build_docs: &if-label-build_docs
  if: '$BOT_LABEL_BUILD_DOCS || $CI_MERGE_REQUEST_LABELS =~ /^(?:[^,\n\r]+,)*build_docs(?:,[^,\n\r]+)*$/i'

.if-label-docs_full: &if-label-docs_full
  if: '$BOT_LABEL_DOCS_FULL || $CI_MERGE_REQUEST_LABELS =~ /^(?:[^,\n\r]+,)*docs_full(?:,[^,\n\r]+)*$/i'

.if-dev-push: &if-dev-push
  if: '$CI_COMMIT_REF_NAME != "master" && $CI_COMMIT_BRANCH !~ /^release\/v/ && $CI_COMMIT_TAG !~ /^v\d+\.\d+(\.\d+)?($|-)/ && $CI_COMMIT_TAG !~ /^qa-test/ && ($CI_PIPELINE_SOURCE == "push" || $CI_PIPELINE_SOURCE == "merge_request_event")'

.doc-rules:build:docs-full:
  rules:
    - <<: *if-qa-test-tag
      when: never
    - <<: *if-protected-check
    - <<: *if-label-build_docs
    - <<: *if-label-docs_full
    - <<: *if-dev-push
      changes: *patterns-docs-full

.doc-rules:build:docs-partial:
  rules:
    - <<: *if-qa-test-tag
      when: never
    - <<: *if-dev-push
      changes: *patterns-docs-full
      when: never
    - <<: *if-dev-push
      changes: *patterns-docs-partial

# stage: pre_check
check_readme_links:
  extends:
    - .pre_check_template
  variables:
    GIT_STRATEGY: "fetch"
  tags: ["check_doc_links"]
  allow_failure: true
  rules:
    - <<: *if-protected-check
    - <<: *if-dev-push
      changes: *patterns-example-readme
  script:
    - python ${IDF_PATH}/tools/ci/check_readme_links.py

check_docs_lang_sync:
  extends:
    - .pre_check_template
    - .doc-rules:build:docs-full
  script:
    - cd docs
    - ./check_lang_folder_sync.sh

.build_docs_template:
  image: $ESP_IDF_DOC_ENV_IMAGE
  stage: build_doc
  tags:
    - build_docs
  needs:
    - job: fast_template_app
      artifacts: false
      optional: true
  script:
    - if [ -n "${BREATHE_ALT_INSTALL_URL_PY39}" ]; then
        pip uninstall -y breathe && pip install -U ${BREATHE_ALT_INSTALL_URL_PY39};
      fi
    - cd docs
    - build-docs -t $DOCTGT -bs $DOC_BUILDERS -l $DOCLANG build
  parallel:
    matrix:
      - DOCLANG: ["en", "zh_CN"]
        DOCTGT: ["esp32", "esp32s2", "esp32s3", "esp32s31", "esp32c3", "esp32c2", "esp32c6", "esp32c61", "esp32c5", "esp32h2", "esp32h4", "esp32h21", "esp32p4"]

check_docs_gh_links:
  image: $ESP_IDF_DOC_ENV_IMAGE
  extends:
    - .pre_check_template
    - .doc-rules:build:docs-full
  variables:
    GIT_STRATEGY: "fetch"
  tags: ["check_doc_links"]
  script:
    - cd docs
    - build-docs gh-linkcheck

# Doc jobs have a lot of special cases, we specify rules here directly instead
# in dependencies.yml to simplify things
build_docs_html_full:
  extends:
    - .build_docs_template
    - .doc-rules:build:docs-full
  artifacts:
    when: always
    paths:
      - docs/_build/*/*/*.txt
      - docs/_build/*/*/html/*
    expire_in: 4 days
  variables:
    DOC_BUILDERS: "html"

build_docs_html_partial:
  extends:
    - .build_docs_template
    - .doc-rules:build:docs-partial
  artifacts:
    when: always
    paths:
      - docs/_build/*/*/*.txt
      - docs/_build/*/*/html/*
    expire_in: 4 days
  variables:
    DOC_BUILDERS: "html"
  parallel:
    matrix:
      - DOCLANG: "en"
        DOCTGT: "esp32"
      - DOCLANG: "zh_CN"
        DOCTGT: "esp32p4"

check_doc_links:
  extends:
    - .build_docs_template
    - .rules:protected:deploy
  stage: post_deploy
  needs:
    - job: deploy_docs_production
      artifacts: false
  variables:
    GIT_STRATEGY: "fetch"
  tags: ["check_doc_links"]
  artifacts:
    when: always
    paths:
      - docs/_build/*/*/*.txt
      - docs/_build/*/*/linkcheck/*.txt
    expire_in: 1 week
  allow_failure: true
  script:
    - cd docs
    - build-docs -t $DOCTGT -l $DOCLANG linkcheck
